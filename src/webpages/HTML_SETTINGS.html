%pre_head_template%
<figure class="text-center">
  <h1>Settings</h1>
</figure>
<div class="d-grid gap-2">
  <form>
    <div class="input-group">
      <input class="form-control" id="uploadform" aria-describedby="uploadform" aria-label="Upload" type="file"
        name="update">
      <input class="btn btn-outline-secondary" id="uploadform" type="button" value="Update" onclick="postFile()">
    </div>
  </form>
  <div class="row gx-0 mb-2" style="display:none;" id="uploadbar">
    <div class="col">
      <div class="progress" style="height:1.8rem;">
        <div id="progress-bar-file1" class="progress progress-bar" role="progressbar" style="width:0%%;height:1.8rem;"
          aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
    </div>
  </div>
  <a class="btn btn-primary" href="/settingsedit" role="button">Configure</a>
  <a class="btn btn-primary" onclick='SendDateString();' role="button">Set device time from computer</a>
  <a class="btn btn-warning" href="/reboot" role="button">Reboot</a>
  <a class="btn btn-primary" href="/confirmreset" role="button">Reset ESP</a>
  <a class="btn btn-primary" href="/webserial" role="button" target="_blank">WebSerial</a>
  <a class="btn btn-primary" href="/" role="button">Back</a>
</div>
<script>
  function postFile() {
    var formdata = new FormData();
    formdata.append('uploadform', $('#uploadform')[0].files[0]);
    var request = new XMLHttpRequest();
    request.onreadystatechange = function () {
      if (request.readyState == XMLHttpRequest.DONE) {
        $('#progress-bar-file1').html(request.responseText);
        if(request.responseText == "Success"){
          window.location.href = "/reboot";
        }
      }
    }
    request.upload.addEventListener('progress', function (e) {
      var file1Size = $('#uploadform')[0].files[0].size;
      document.getElementById('uploadbar').style.display = '';

      if (e.loaded <= file1Size) {
        var percent = Math.round(e.loaded / file1Size * 100);
        $('#progress-bar-file1').width(percent + '%%').html(percent + '%%');
      }

      if (e.loaded == e.total) {
        $('#progress-bar-file1').width(100 + '%%').html(100 + '%%');
      }
    });
    request.open('post', '/update');
    request.timeout = 45000;
    request.send(formdata);
  }

  function SendDateString() {
    var today = new Date();
    var dateString;
    dateString = (today.getFullYear().toString().slice(2, 4)) +
      ((today.getMonth() + 1) < 10 ? '0' : '') + (today.getMonth() + 1) +
      (today.getDate() < 10 ? '0' : '') + today.getDate() +
      (today.getHours() < 10 ? '0' : '') + today.getHours() +
      (today.getMinutes() < 10 ? '0' : '') + today.getMinutes() +
      (today.getSeconds() < 10 ? '0' : '') + today.getSeconds();
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = () => {
      if (xhr.readyState === 4) {
        window.location.href = '/';
      }
    }
    xhr.open("GET", "/set?datetime=" + dateString, true);
    xhr.send();
  }
</script>
%pre_foot_template%
<p hidden></p>